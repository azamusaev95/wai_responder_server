// controllers/promptGenerator.js
import axios from "axios";
import User from "../models/User.js";

// –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ AI —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
const AI_INTERVIEWER_SYSTEM_PROMPT = `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è WhatsApp AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é (8-12 –≤–æ–ø—Ä–æ—Å–æ–≤) —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –±–∏–∑–Ω–µ—Å–∞, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å:

–û–°–ù–û–í–ù–´–ï –í–û–ü–†–û–°–´:
1. –ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –±–∏–∑–Ω–µ—Å
2. –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç –∫–ª–∏–µ–Ω—Ç–∞–º
3. –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏/–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
4. –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è

–î–û–°–¢–ê–í–ö–ê (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ):
5. –ï—Å—Ç—å –ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥?
6. –ö—É–¥–∞ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ? (—Ä–∞–π–æ–Ω, –≥–æ—Ä–æ–¥, —Ä–µ–≥–∏–æ–Ω)
7. –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏
8. –£—Å–ª–æ–≤–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
9. –°—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ (–∫–∞–∫ –±—ã—Å—Ç—Ä–æ)

–ö–û–ù–¢–ê–ö–¢–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø (–≤–∞–∂–Ω–æ!):
10. –§–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ñ–∏—Å/–º–∞–≥–∞–∑–∏–Ω/—Ç–æ—á–∫–∞)
11. –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã (–Ω–∞–ª–∏—á–Ω—ã–µ, –∫–∞—Ä—Ç—ã, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏)
12. –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã (–Ω–æ–º–µ—Ä–∞ –∫–æ—à–µ–ª—å–∫–æ–≤, –∫–∞—Ä—Ç, –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã)
13. –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
14. –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç–µ–ª–µ—Ñ–æ–Ω, email, —Å–æ—Ü—Å–µ—Ç–∏)

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
15. –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è (—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π/–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π)
16. –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤ (—Ä—É—Å—Å–∫–∏–π/–∫—ã—Ä–≥—ã–∑—Å–∫–∏–π/–∞–≤—Ç–æ)

–ü–†–ê–í–ò–õ–ê –ò–ù–¢–ï–†–í–¨–Æ:
- –ó–∞–¥–∞–≤–∞–π –û–î–ò–ù –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑
- –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –∫—Ä–∞—Ç–∫–∏–º
- –ê–¥–∞–ø—Ç–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥ —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞:
  * –î–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–æ–≤/–¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–ø—Ä–æ—Å–∏ –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É
  * –î–ª—è —É—Å–ª—É–≥ –Ω–∞ –≤—ã–µ–∑–¥–µ ‚Äî —Å–ø—Ä–æ—Å–∏ –ø—Ä–æ –∑–æ–Ω—É –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
  * –î–ª—è –æ—Ñ–ª–∞–π–Ω –±–∏–∑–Ω–µ—Å–∞ –±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É
  * –û–Ω–ª–∞–π–Ω –±–∏–∑–Ω–µ—Å—É –Ω–µ –Ω—É–∂–µ–Ω —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
- –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ–ø–æ–ª–Ω—ã–π - —É—Ç–æ—á–Ω–∏
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏
- –°–ø—Ä–∞—à–∏–≤–∞–π –ø—Ä–æ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
- –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã - —Å–ø—Ä–æ—Å–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
- –ü–æ—Å–ª–µ 8-12 –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–∫–∞–∂–∏ "INTERVIEW_COMPLETE"

–ü–†–ò–ú–ï–†–´ –í–û–ü–†–û–°–û–í:

–û –±–∏–∑–Ω–µ—Å–µ:
- "–ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≤–∞—à –±–∏–∑–Ω–µ—Å? –ß—Ç–æ –≤—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞–º? üè¢"
- "–ß—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç –≤–∞—Å –æ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤? –í —á—ë–º –≤–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞? ‚ú®"

–û –¥–æ—Å—Ç–∞–≤–∫–µ:
- "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –¥–æ—Å—Ç–∞–≤–∫–∞? üöö"
- "–ö—É–¥–∞ –≤—ã –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ? (—Ä–∞–π–æ–Ω, –≥–æ—Ä–æ–¥, –≤—Å—è —Å—Ç—Ä–∞–Ω–∞?)"
- "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –¥–æ—Å—Ç–∞–≤–∫–∞? –ï—Å—Ç—å –ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç –∫–∞–∫–æ–π-—Ç–æ —Å—É–º–º—ã?"
- "–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ –∑–∞–∫–∞–∑—ã?"

–û –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö:
- "–ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ? üí≥"
- "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å, –∫—É–¥–∞ –º–æ–≥—É—Ç –ø—Ä–∏–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç—ã? üìç"
- "–ö–∞–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã —è –¥–æ–ª–∂–µ–Ω —Å–æ–æ–±—â–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º? (–Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã, –∫–æ—à–µ–ª—å–∫–∞)"
- "–í –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ? üïê"
- "–ö–∞–∫–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏ —è –¥–æ–ª–∂–µ–Ω –¥–∞–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º?"

–û —Å—Ç–∏–ª–µ:
- "–ö–∞–∫ –≤—ã –æ–±—â–∞–µ—Ç–µ—Å—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ ‚Äî —Ñ–æ—Ä–º–∞–ª—å–Ω–æ –∏–ª–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ? üí¨"
- "–ù–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ –æ—Ç–≤–µ—á–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º? (—Ä—É—Å—Å–∫–∏–π/–∫—ã—Ä–≥—ã–∑—Å–∫–∏–π/–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å)"

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):
{
  "question": "–¢–≤–æ–π –≤–æ–ø—Ä–æ—Å –∑–¥–µ—Å—å",
  "isComplete": false
}

–ö–æ–≥–¥–∞ –∏–Ω—Ç–µ—Ä–≤—å—é –∑–∞–∫–æ–Ω—á–µ–Ω–æ:
{
  "question": "–û—Ç–ª–∏—á–Ω–æ! –°–µ–π—á–∞—Å —Å–æ–∑–¥–∞–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞ ‚ú®",
  "isComplete": true
}`;

// –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏
const PROMPT_GENERATOR_SYSTEM = `–ù–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ç–µ—Ä–≤—å—é —Å–æ–∑–¥–∞–π –ò–î–ï–ê–õ–¨–ù–´–ô —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è WhatsApp AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. 300-700 —Å–∏–º–≤–æ–ª–æ–≤
2. –Ø–∑—ã–∫ –ø—Ä–æ–º–ø—Ç–∞ = —è–∑—ã–∫ –∫–æ—Ç–æ—Ä—ã–π –≤—ã–±—Ä–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–ª–∏ –∞–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
3. –ö–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ –æ –±–∏–∑–Ω–µ—Å–µ, –±–µ–∑ –æ–±—â–∏—Ö —Ñ—Ä–∞–∑
4. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∏ –≤—Å—é –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
5. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–Ω –æ–±—â–µ–Ω–∏—è
6. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ —è–∑—ã–∫–µ –æ—Ç–≤–µ—Ç–æ–≤
7. –ë–ï–ó —Ñ—Ä–∞–∑ "–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç" - –ø–∏—à–∏ –æ—Ç –ª–∏—Ü–∞ –±–∏–∑–Ω–µ—Å–∞

–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ú–ü–¢–ê:
1. –ö—Ç–æ –º—ã –∏ —á—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
2. –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)
3. –î–û–°–¢–ê–í–ö–ê (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ):
   - –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
   - –°—Ç–æ–∏–º–æ—Å—Ç—å –∏ —É—Å–ª–æ–≤–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏
   - –°—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
4. –ö–û–ù–¢–ê–ö–¢–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø (–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ!):
   - –§–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
   - –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
   - –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã (–Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç, –∫–æ—à–µ–ª—å–∫–æ–≤ –∏ —Ç.–¥.)
   - –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏
5. –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –∏ —è–∑—ã–∫

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ü–†–û–ú–ü–¢–ê:

–ü—Ä–∏–º–µ—Ä 1 (—Å –¥–æ—Å—Ç–∞–≤–∫–æ–π):
"–ú—ã ‚Äî –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω –∫–æ—Å–º–µ—Ç–∏–∫–∏ –∏–∑ –ë–∏—à–∫–µ–∫–∞. –ü—Ä–æ–¥–∞—ë–º –∫–æ—Ä–µ–π—Å–∫—É—é –∏ –µ–≤—Ä–æ–ø–µ–π—Å–∫—É—é –∫–æ—Å–º–µ—Ç–∏–∫—É –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º —Ü–µ–Ω–∞–º.

üöö –î–æ—Å—Ç–∞–≤–∫–∞: 
- –ë–∏—à–∫–µ–∫ ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç 2000 —Å–æ–º (–æ–±—ã—á–Ω–æ 150 —Å–æ–º)
- –ü–æ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω—É ‚Äî 200 —Å–æ–º
- –î–æ—Å—Ç–∞–≤–ª—è–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 1-3 —á–∞—Å–æ–≤ –ø–æ –ë–∏—à–∫–µ–∫—É

üí≥ –û–ø–ª–∞—Ç–∞: –Ω–∞–ª–∏—á–Ω—ã–º–∏ –∫—É—Ä—å–µ—Ä—É, MBank, –≠–ª—Å–æ–º, –∫–∞—Ä—Ç—ã Visa/MasterCard
üì± –†–µ–∫–≤–∏–∑–∏—Ç—ã:
- MBank: 0555 777 888
- –≠–ª—Å–æ–º: 0700 999 000
- –ö–∞—Ä—Ç–∞: 4169 1234 5678 9012 (–ù—É—Ä–≥—É–ª—å –¢.)
üïê –†–∞–±–æ—Ç–∞–µ–º: 9:00-21:00 –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
‚òéÔ∏è –ö–æ–Ω—Ç–∞–∫—Ç—ã: WhatsApp +996555777888, Instagram @kosmetika_kg

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –∫—ã—Ä–≥—ã–∑—Å–∫–æ–º - –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π. –ü—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã."

–ü—Ä–∏–º–µ—Ä 2 (—É—Å–ª—É–≥–∏ —Å –≤—ã–µ–∑–¥–æ–º):
"–ú—ã ‚Äî –∫–ª–∏–Ω–∏–Ω–≥–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è –≤ –ë–∏—à–∫–µ–∫–µ. –£–±–∏—Ä–∞–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã, –æ—Ñ–∏—Å—ã, –ø–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ —ç–∫–æ-—Å—Ä–µ–¥—Å—Ç–≤–∞.

üöó –í—ã–µ–∑–¥: –ø–æ –≤—Å–µ–º—É –ë–∏—à–∫–µ–∫—É –∏ –ø—Ä–∏–≥–æ—Ä–æ–¥—É (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
‚è± –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 8:00-22:00 –µ–∂–µ–¥–Ω–µ–≤–Ω–æ

üìç –ê–¥—Ä–µ—Å –æ—Ñ–∏—Å–∞: —É–ª. –ß—É–π 123, –æ—Ñ–∏—Å 45 (–¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π)
üí≥ –û–ø–ª–∞—Ç–∞: –Ω–∞–ª–∏—á–Ω—ã–µ, –≠–ª—Å–æ–º, MBank, –∫–∞—Ä—Ç—ã
üì± –†–µ–∫–≤–∏–∑–∏—Ç—ã: 
- –≠–ª—Å–æ–º: 0555 123 456
- MBank: 0777 654 321
‚òéÔ∏è –¢–µ–ª–µ—Ñ–æ–Ω: +996555123456

–û—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞. –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è). –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ —Ü–µ–Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤—ã–µ–∑–¥ –¥–ª—è –æ—Ü–µ–Ω–∫–∏."

–ü—Ä–∏–º–µ—Ä 3 (–æ—Ñ–ª–∞–π–Ω –º–∞–≥–∞–∑–∏–Ω –±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏):
"–ú—ã ‚Äî –º–∞–≥–∞–∑–∏–Ω –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–µ–π –≤ –ë–∏—à–∫–µ–∫–µ. –ë–æ–ª—å—à–æ–π –≤—ã–±–æ—Ä –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤ –¥–ª—è —è–ø–æ–Ω—Å–∫–∏—Ö –∏ –∫–æ—Ä–µ–π—Å–∫–∏—Ö –∞–≤—Ç–æ.

üìç –ê–¥—Ä–µ—Å: —É–ª. –ò–±—Ä–∞–∏–º–æ–≤–∞ 103, —Ä—ã–Ω–æ–∫ –î–æ—Ä–¥–æ–π, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä 2545
üïê –†–∞–±–æ—Ç–∞–µ–º: 8:00-19:00, –±–µ–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö
üí≥ –û–ø–ª–∞—Ç–∞: –Ω–∞–ª–∏—á–Ω—ã–µ, –∫–∞—Ä—Ç—ã, MBank, –≠–ª—Å–æ–º
üì± –†–µ–∫–≤–∏–∑–∏—Ç—ã:
- MBank: 0555 444 333
- –≠–ª—Å–æ–º: 0700 222 111
‚òéÔ∏è –¢–µ–ª–µ—Ñ–æ–Ω—ã: +996555444333, +996700222111

–û—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –ø–æ –¥–µ–ª—É. –£—Ç–æ—á–Ω—è–π –º–∞—Ä–∫—É –∏ –≥–æ–¥ –∞–≤—Ç–æ –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π."

–í–ê–ñ–ù–û:
- –í—Å–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –ø–∏—à–∏ –¢–û–ß–ù–û –∫–∞–∫ —Å–∫–∞–∑–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –∫—Ä–∞—Å–∏–≤–æ —Å —ç–º–æ–¥–∑–∏
- –ì—Ä—É–ø–ø–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ª–æ–≥–∏—á–µ—Å–∫–∏
- –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∞ - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏ –¥–µ—Ç–∞–ª–∏
- –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ - –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –µ—ë –≤–æ–æ–±—â–µ

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`;

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π –∏–Ω—Ç–µ—Ä–≤—å—é
const interviewSessions = new Map();

// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π (—Å—Ç–∞—Ä—à–µ 2 —á–∞—Å–æ–≤)
setInterval(() => {
  const now = Date.now();
  for (const [sessionId, session] of interviewSessions.entries()) {
    if (now - session.timestamp > 2 * 60 * 60 * 1000) {
      interviewSessions.delete(sessionId);
      console.log(`[INTERVIEW] Session ${sessionId} expired and removed`);
    }
  }
}, 15 * 60 * 1000); // –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç

// –ù–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
export async function startInterview(req, res) {
  try {
    const { deviceId } = req.body;

    if (!deviceId) {
      return res.status(400).json({ error: "deviceId is required" });
    }

    // –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é
    const sessionId = `${deviceId}_${Date.now()}`;

    interviewSessions.set(sessionId, {
      deviceId,
      messages: [],
      timestamp: Date.now(),
    });

    // –ü–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
    const firstQuestion =
      "–ü—Ä–∏–≤–µ—Ç! üëã –Ø –ø–æ–º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∞—à–µ–≥–æ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.\n\n–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º: —á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≤–∞—à –±–∏–∑–Ω–µ—Å? –ß—Ç–æ –≤—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞–º?";

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –≤ —Å–µ—Å—Å–∏—é
    const session = interviewSessions.get(sessionId);
    session.messages.push({
      role: "assistant",
      content: firstQuestion,
    });

    console.log(`[INTERVIEW] Started session ${sessionId}`);

    res.json({
      success: true,
      sessionId,
      question: firstQuestion,
      questionNumber: 1,
      isComplete: false,
    });
  } catch (e) {
    console.error("[INTERVIEW] Error starting:", e);
    res.status(500).json({ error: "Internal server error" });
  }
}

// –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π
export async function answerQuestion(req, res) {
  try {
    const { sessionId, answer } = req.body;

    if (!sessionId || !answer) {
      return res.status(400).json({ error: "Missing required fields" });
    }

    const session = interviewSessions.get(sessionId);

    if (!session) {
      return res.status(404).json({ error: "Session not found or expired" });
    }

    // –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    session.messages.push({
      role: "user",
      content: answer,
    });

    // –û–±–Ω–æ–≤–∏—Ç—å timestamp
    session.timestamp = Date.now();

    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
    const questionCount = session.messages.filter(
      (m) => m.role === "user"
    ).length;

    console.log(
      `[INTERVIEW] Session ${sessionId} - Question ${questionCount}/12`
    );

    // –ï—Å–ª–∏ —É–∂–µ –∑–∞–¥–∞–ª–∏ 12 –≤–æ–ø—Ä–æ—Å–æ–≤ - –∑–∞–≤–µ—Ä—à–∞–µ–º
    if (questionCount >= 12) {
      const completeMessage =
        "–û—Ç–ª–∏—á–Ω–æ! –°–æ–±—Ä–∞–ª –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –°–µ–π—á–∞—Å —Å–æ–∑–¥–∞–º –∏–¥–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞ ‚ú®";

      session.messages.push({
        role: "assistant",
        content: completeMessage,
      });

      console.log(
        `[INTERVIEW] Session ${sessionId} completed with ${questionCount} questions`
      );

      return res.json({
        success: true,
        sessionId,
        question: completeMessage,
        questionNumber: questionCount + 1,
        isComplete: true,
      });
    }

    // –ó–∞–ø—Ä–æ—Å –∫ AI –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-4o",
        messages: [
          { role: "system", content: AI_INTERVIEWER_SYSTEM_PROMPT },
          ...session.messages,
        ],
        temperature: 0.7,
        max_tokens: 250,
      },
      {
        timeout: 20000,
        headers: {
          Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
          "Content-Type": "application/json",
        },
      }
    );

    const aiResponse =
      response?.data?.choices?.[0]?.message?.content?.trim() || "";

    if (!aiResponse) {
      throw new Error("No response from AI");
    }

    // –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
    let nextQuestion = aiResponse;
    let isComplete = false;

    try {
      const parsed = JSON.parse(aiResponse);
      nextQuestion = parsed.question || aiResponse;
      isComplete = parsed.isComplete || false;
    } catch {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      isComplete =
        aiResponse.includes("INTERVIEW_COMPLETE") ||
        questionCount >= 11 ||
        aiResponse.toLowerCase().includes("—Å–æ–∑–¥–∞–º –ø—Ä–æ–º–ø—Ç");

      if (isComplete) {
        nextQuestion =
          "–û—Ç–ª–∏—á–Ω–æ! –°–æ–±—Ä–∞–ª –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –°–µ–π—á–∞—Å —Å–æ–∑–¥–∞–º –∏–¥–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞ ‚ú®";
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
    session.messages.push({
      role: "assistant",
      content: nextQuestion,
    });

    res.json({
      success: true,
      sessionId,
      question: nextQuestion,
      questionNumber: questionCount + 1,
      isComplete,
    });
  } catch (e) {
    console.error("[INTERVIEW] Error answering:", e);
    const status = e?.response?.status || 500;
    res.status(status).json({ error: "Failed to get next question" });
  }
}

export async function generatePromptFromInterview(req, res) {
  try {
    const { sessionId } = req.body;

    if (!sessionId) {
      return res.status(400).json({ error: "sessionId is required" });
    }

    const session = interviewSessions.get(sessionId);

    if (!session) {
      return res.status(404).json({ error: "Session not found or expired" });
    }

    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let isPro = false;
    try {
      const user = await User.findOne({
        where: { deviceId: session.deviceId },
      });
      if (user && user.isPro) {
        isPro = true;
      }
    } catch (err) {
      console.error("[PROMPT_GEN] Error checking user status:", err);
    }

    // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –¥–ª–∏–Ω–µ (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ max_tokens)
    const lengthInstruction = isPro
      ? "–î–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞: –æ—Ç 500 –¥–æ 1500 —Å–∏–º–≤–æ–ª–æ–≤. –°–¥–µ–ª–∞–π –µ–≥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–º, –∫—Ä–∞—Å–∏–≤—ã–º –∏ –ø—Ä–æ–¥–∞—é—â–∏–º."
      : "–°–¢–†–û–ì–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –î–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞ –ù–ï –ë–û–õ–ï–ï 600 —Å–∏–º–≤–æ–ª–æ–≤. –ü–∏—à–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ, —É–±–µ—Ä–∏ –ª–∏—à–Ω–∏–µ —Å–ª–æ–≤–∞, –æ—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ —Å–∞–º—É—é –≤–∞–∂–Ω—É—é —Å—É—Ç—å –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã.";

    console.log(
      `[PROMPT_GEN] Generating prompt for session ${sessionId}. User is PRO: ${isPro}`
    );

    const interviewTranscript = session.messages
      .map(
        (m) =>
          `${m.role === "user" ? "–í–ª–∞–¥–µ–ª–µ—Ü –±–∏–∑–Ω–µ—Å–∞" : "–ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä"}: ${
            m.content
          }`
      )
      .join("\n\n");

    // –ó–∞–ø—Ä–æ—Å –∫ AI
    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-4o-mini", // gpt-4o-mini –æ—Ç–ª–∏—á–Ω–æ —Å–ª–µ–¥—É–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø–æ –¥–ª–∏–Ω–µ
        messages: [
          { role: "system", content: PROMPT_GENERATOR_SYSTEM },
          // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–ª–∏–Ω–µ
          { role: "system", content: lengthInstruction },
          {
            role: "user",
            content: `–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤—å—é —Å–æ–∑–¥–∞–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:\n\n${interviewTranscript}`,
          },
        ],
        temperature: 0.7,
        // max_tokens –£–ë–†–ê–ù, —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
      },
      {
        timeout: 30000,
        headers: {
          Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
          "Content-Type": "application/json",
        },
      }
    );

    const generatedPrompt =
      response?.data?.choices?.[0]?.message?.content?.trim() || "";

    if (!generatedPrompt) {
      throw new Error("Failed to generate prompt");
    }

    res.json({
      success: true,
      prompt: generatedPrompt,
      sessionId,
      isPro,
    });
  } catch (e) {
    console.error("[PROMPT_GEN] Error generating:", e);
    const status = e?.response?.status || 500;
    res.status(status).json({ error: "Failed to generate prompt" });
  }
}

// –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç (—Å —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏)
export async function regeneratePrompt(req, res) {
  try {
    const { sessionId } = req.body;

    if (!sessionId) {
      return res.status(400).json({ error: "sessionId is required" });
    }

    const session = interviewSessions.get(sessionId);

    if (!session) {
      return res.status(404).json({ error: "Session not found or expired" });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    let isPro = false;
    try {
      const user = await User.findOne({
        where: { deviceId: session.deviceId },
      });
      if (user && user.isPro) isPro = true;
    } catch (err) {
      console.error("[PROMPT_GEN] Error checking user status:", err);
    }

    const lengthInstruction = isPro
      ? "–î–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞: –æ—Ç 500 –¥–æ 1500 —Å–∏–º–≤–æ–ª–æ–≤. –†–∞—Å–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ."
      : "–°–¢–†–û–ì–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –î–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞ –ù–ï –ë–û–õ–ï–ï 600 —Å–∏–º–≤–æ–ª–æ–≤. –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫.";

    console.log(`[PROMPT_GEN] Regenerating prompt for session ${sessionId}`);

    const interviewTranscript = session.messages
      .map(
        (m) =>
          `${m.role === "user" ? "–í–ª–∞–¥–µ–ª–µ—Ü –±–∏–∑–Ω–µ—Å–∞" : "–ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä"}: ${
            m.content
          }`
      )
      .join("\n\n");

    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-4o-mini",
        messages: [
          {
            role: "system",
            content:
              PROMPT_GENERATOR_SYSTEM +
              "\n\n–°–æ–∑–¥–∞–π –î–†–£–ì–û–ô –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä–æ–º–ø—Ç–∞ (–∏–∑–º–µ–Ω–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏).",
          },
          { role: "system", content: lengthInstruction },
          {
            role: "user",
            content: `–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤—å—é —Å–æ–∑–¥–∞–π –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:\n\n${interviewTranscript}`,
          },
        ],
        temperature: 0.9,
        // max_tokens –£–ë–†–ê–ù
      },
      {
        timeout: 30000,
        headers: {
          Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
          "Content-Type": "application/json",
        },
      }
    );

    const generatedPrompt =
      response?.data?.choices?.[0]?.message?.content?.trim() || "";

    if (!generatedPrompt) {
      throw new Error("Failed to regenerate prompt");
    }

    res.json({
      success: true,
      prompt: generatedPrompt,
      sessionId,
    });
  } catch (e) {
    console.error("[PROMPT_GEN] Error regenerating:", e);
    const status = e?.response?.status || 500;
    res.status(status).json({ error: "Failed to regenerate prompt" });
  }
}

// –û—Ç–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
export async function cancelInterview(req, res) {
  try {
    const { sessionId } = req.body;

    if (!sessionId) {
      return res.status(400).json({ error: "sessionId is required" });
    }

    const deleted = interviewSessions.delete(sessionId);

    console.log(
      `[INTERVIEW] Session ${sessionId} ${deleted ? "cancelled" : "not found"}`
    );

    res.json({
      success: true,
      message: deleted ? "Interview cancelled" : "Session not found",
    });
  } catch (e) {
    console.error("[INTERVIEW] Error cancelling:", e);
    res.status(500).json({ error: "Internal server error" });
  }
}
